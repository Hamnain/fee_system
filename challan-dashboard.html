<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Challan Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    
    <style>
        body { background-color: #f8f9fa; }
        .sidebar { position: fixed; top: 0; left: 0; width: 260px; height: 100vh; background-color: #2c3e50; color: #ecf0f1; padding: 1.5rem; transform: translateX(-100%); transition: transform 0.3s ease-in-out; z-index: 1050; overflow-y: auto; }
        .sidebar.active { transform: translateX(0); }
        .sidebar-header { margin-bottom: 2rem; text-align: center; }
        .sidebar-header h3 { color: #ffffff; font-weight: 700; }
        .sidebar-nav { list-style: none; padding: 0; }
        .sidebar-nav li { margin-bottom: 0.5rem; }
        .sidebar-nav a { display: flex; align-items: center; padding: 0.75rem 1rem; border-radius: 8px; color: #ecf0f1; text-decoration: none; font-size: 1.1rem; font-weight: 500; transition: background-color 0.2s; }
        .sidebar-nav a i { margin-right: 0.75rem; }
        .sidebar-nav a:hover { background-color: #34495e; }
        .sidebar-nav a.active { background-color: #1abc9c; color: #ffffff; }
        .sidebar-toggle-btn { position: fixed; top: 15px; left: 15px; font-size: 1.8rem; background-color: #fff; border: none; border-radius: 8px; padding: 5px 12px; z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .main-content { padding: 2rem; padding-top: 80px; transition: margin-left 0.3s ease-in-out; margin-left: 0; }
        body.sidebar-active .main-content { margin-left: 260px; }
        .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 1040; }
        .sidebar-overlay.active { display: block; }
        @media (max-width: 992px) { body.sidebar-active .main-content { margin-left: 0; } }
             .sidebar-logo {
    width: 90px;  /* You can change this value to make it smaller or larger */
    height: auto;
    margin-bottom: 0.75rem;
    border-radius: 8px;
}
    </style>
</head>
<body>

    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
           <img src="/Logo.jpg" alt="IIUI Logo" class="sidebar-logo">     
        </div>
        <ul class="sidebar-nav">
            <li>
                <a href="index.html">
                    <i class="bi bi-person-plus-fill"></i> New Admission
                </a>
            </li>
            <li>
                <a href="dashboard.html">
                    <i class="bi bi-speedometer2"></i> Dashboard
                </a>
            </li>
            <li>
                <a href="challan-dashboard.html" class="active"> <i class="bi bi-receipt-cutoff"></i> Challan Section
                </a>
            </li>
        </ul>
    </div>
    <div class="sidebar-overlay" id="sidebar-overlay"></div>

    <main class="main-content" id="main-content">
        <button class="btn sidebar-toggle-btn" id="sidebar-toggle">
            <i class="bi bi-list"></i>
        </button>

        <div class="container-fluid">
            <h1 class="mb-4">Challan Management</h1>
            
            <div class="card shadow-sm mb-4">
                <div class="card-body d-flex flex-wrap gap-2">
                    <button class="btn btn-primary" id="select-unpaid-btn">Select All Unpaid</button>
                    <button class="btn btn-secondary" id="deselect-all-btn">Deselect All</button>
                    <button class="btn btn-success" id="print-selected-btn">
                        <i class="bi bi-printer-fill me-2"></i> Print Selected Challans
                    </button>
                </div>
            </div>

            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-dark">
                                <tr>
                                    <th><input type="checkbox" id="select-all-header"></th>
                                    <th>Student Name</th>
                                    <th>Admission ID</th>
                                    <th>Class</th>
                                    <th>Fee Status</th>
                                </tr>
                            </thead>
                            <tbody id="student-list-body">
                                <tr>
                                    <td colspan="5" class="text-center">Loading students...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const sidebar = document.getElementById('sidebar');
            const toggleBtn = document.getElementById('sidebar-toggle');
            const overlay = document.getElementById('sidebar-overlay');
            const toggleSidebar = () => {
                sidebar.classList.toggle('active');
                overlay.classList.toggle('active');
                document.body.classList.toggle('sidebar-active');
            };
            toggleBtn.addEventListener('click', toggleSidebar);
            overlay.addEventListener('click', toggleSidebar);
        });
    </script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- Your Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyDIVlksOyjV4e6TyiJysL7ovITrQ60v7Q4",
            authDomain: "feesystem-fe78e.firebaseapp.com",
            projectId: "feesystem-fe78e",
            storageBucket: "feesystem-fe78e.firebasestorage.app",
            messagingSenderId: "772128934957",
            appId: "1:772128934957:web:0eeeebed3be0343cf77ca4",
            measurementId: "G-XQ0HWT03HK"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const tableBody = document.getElementById('student-list-body');
        const selectUnpaidBtn = document.getElementById('select-unpaid-btn');
        const deselectAllBtn = document.getElementById('deselect-all-btn');
        const printSelectedBtn = document.getElementById('print-selected-btn');
        const selectAllHeader = document.getElementById('select-all-header');

        // Helper function from your dashboard
        function getOverallFeeStatus(feeStatus) {
            if (!feeStatus) return { statusBadge: `<span class="badge bg-secondary">New</span>`, status: 'new' };
            let allPaid = true, nonePaid = true;
            for (const feeName in feeStatus) {
                if (feeStatus[feeName].status === 'paid') nonePaid = false;
                else allPaid = false;
            }
            if (allPaid) return { statusBadge: `<span class="badge bg-success">Paid</span>`, status: 'paid' };
            if (nonePaid) return { statusBadge: `<span class="badge bg-danger">Pending</span>`, status: 'unpaid' };
            return { statusBadge: `<span class="badge bg-warning text-dark">Partial</span>`, status: 'unpaid' };
        }

        // Fetch and display all students
        async function fetchStudentsForChallan() {
            tableBody.innerHTML = '';
            const querySnapshot = await getDocs(collection(db, "admissions"));
            
            if (querySnapshot.empty) {
                tableBody.innerHTML = `<tr><td colspan="5" class="text-center">No students found.</td></tr>`;
                return;
            }

            querySnapshot.forEach((doc) => {
                const student = doc.data();
                const { statusBadge, status } = getOverallFeeStatus(student.feeStatus);
                const row = `
                    <tr data-status="${status}">
                        <td>
                            <input type="checkbox" class="form-check-input student-checkbox" data-id="${doc.id}">
                        </td>
                        <td>${student.studentName}</td>
                        <td>${student.admissionId}</td>
                        <td>${student.studentClass}</td>
                        <td>${statusBadge}</td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
        }

        // --- Button Click Listeners ---
        
        // Select All (Unpaid)
        selectUnpaidBtn.addEventListener('click', () => {
            document.querySelectorAll('.student-checkbox').forEach(box => {
                const rowStatus = box.closest('tr').dataset.status;
                box.checked = (rowStatus === 'unpaid' || rowStatus === 'new');
            });
        });

        // Deselect All
        deselectAllBtn.addEventListener('click', () => {
            document.querySelectorAll('.student-checkbox').forEach(box => box.checked = false);
        });

        // Header checkbox selects/deselects all
        selectAllHeader.addEventListener('click', () => {
            const isChecked = selectAllHeader.checked;
            document.querySelectorAll('.student-checkbox').forEach(box => box.checked = isChecked);
        });

        // Print Selected Challans
        printSelectedBtn.addEventListener('click', () => {
            const selectedIds = [];
            document.querySelectorAll('.student-checkbox:checked').forEach(box => {
                selectedIds.push(box.dataset.id);
            });

            if (selectedIds.length === 0) {
                alert('Please select at least one student to print a challan.');
                return;
            }
            
            // 1. Save the list of IDs to localStorage
            localStorage.setItem('printQueue', JSON.stringify(selectedIds));
            
            // 2. Open the new print-all page
            window.open('print-all-challans.html', '_blank');
        });

        fetchStudentsForChallan();
    </script>
</body>
</html>