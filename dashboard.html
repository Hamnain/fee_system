<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            /* Override default Bootstrap primary color with our teal */
            --bs-primary: #00796b;
            --bs-primary-rgb: 0, 121, 107;
        }

        body {
            background-color: #f8f9fa;
            font-family: 'Poppins', sans-serif;
        }
        
        /* --- Sidebar Styles --- */
        .sidebar {
            position: fixed; top: 0; left: 0;
            width: 260px; height: 100vh;
            background-color: #2c3e50;
            color: #ecf0f1;
            padding: 1.5rem;
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
            z-index: 1050;
            overflow-y: auto;
        }
        .sidebar.active { transform: translateX(0); }
        .sidebar-header { margin-bottom: 2rem; text-align: center; }
        .sidebar-header h3 { color: #ffffff; font-weight: 700; }
        .sidebar-nav { list-style: none; padding: 0; }
        .sidebar-nav li { margin-bottom: 0.5rem; }
        .sidebar-nav a {
            display: flex; align-items: center;
            padding: 0.75rem 1rem; border-radius: 8px;
            color: #ecf0f1; text-decoration: none;
            font-size: 1.1rem; font-weight: 500;
            transition: background-color 0.2s;
        }
        .sidebar-nav a i { margin-right: 0.75rem; }
        .sidebar-nav a:hover { background-color: #34495e; }
        .sidebar-nav a.active {
            background-color: var(--bs-primary); /* Use our teal */
            color: #ffffff;
        }
        .sidebar-toggle-btn {
            position: fixed; top: 15px; left: 15px;
            font-size: 1.8rem; background-color: #fff;
            border: none; border-radius: 8px;
            padding: 5px 12px; z-index: 1000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .main-content {
            padding: 2rem;
            padding-top: 80px;
            transition: margin-left 0.3s ease-in-out;
            margin-left: 0;
        }
        body.sidebar-active .main-content {
            margin-left: 260px;
        }
        .sidebar-overlay {
            display: none; position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5); z-index: 1040;
        }
        .sidebar-overlay.active { display: block; }
        @media (max-width: 992px) {
            body.sidebar-active .main-content { margin-left: 0; }
        }
        
        /* --- NEW: Modern Card Styles --- */
        .summary-card .card-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.75rem;
        }
        .summary-card .card-title {
            font-weight: 700;
            font-size: 2rem;
            color: #343a40;
        }
        .summary-card .card-text {
            font-weight: 500;
            color: #6c757d;
        }
        
        /* --- NEW: Table Style Overrides --- */
        .table {
            border-collapse: separate;
            border-spacing: 0;
        }
        .table thead th {
            background-color: #f1f4f8;
            color: #6c757d;
            font-weight: 600;
            border-bottom: 0;
            text-transform: uppercase;
            font-size: 0.85rem;
        }
        .table tbody tr {
            background-color: #ffffff;
        }
        .table tbody tr:hover {
            background-color: #f8f9fa;
        }
        /* New style for the class grouping row */
        .table .class-heading td {
            background-color: #e0f2f1; /* Light teal */
            color: #004d40; /* Dark teal */
            font-weight: 700;
            font-size: 1.1rem;
        }
        .table td, .table th {
            border: none;
            border-bottom: 1px solid #dee2e6; /* Add horizontal rule */
        }
        .card .table {
            border-radius: 0 0 0.375rem 0.375rem; /* Match card radius */
            overflow: hidden;
        }
        .sidebar-logo {
    width: 90px;  /* You can change this value to make it smaller or larger */
    height: auto;
    margin-bottom: 0.75rem;
    border-radius: 8px;
}
    </style>
</head>

<body>

    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
<img src="/Logo.jpg" alt="IIUI Logo" class="sidebar-logo">     
   </div>
        <ul class="sidebar-nav">
            <li>
                <a href="index.html">
                    <i class="bi bi-person-plus-fill"></i> New Admission
                </a>
            </li>
            <li>
                <a href="dashboard.html" class="active">
                    <i class="bi bi-speedometer2"></i> Dashboard
                </a>
            </li>
            <li>
                <a href="challan-dashboard.html">
                    <i class="bi bi-receipt-cutoff"></i> Challan Section
                </a>
            </li>
        </ul>
    </div>
    <div class="sidebar-overlay" id="sidebar-overlay"></div>

    <main class="main-content" id="main-content">
        <button class="btn sidebar-toggle-btn" id="sidebar-toggle">
            <i class="bi bi-list"></i>
        </button>

        <div class="container-fluid">
            
            <h1 class="h2 mb-4">Dashboard</h1>

            <div class="row row-cols-1 row-cols-md-3 g-4 mb-4">
                <div class="col">
                    <div class="card summary-card shadow-sm border-0 h-100">
                        <div class="card-body d-flex align-items-center">
                            <div class="card-icon bg-success-subtle text-success">
                                <i class="bi bi-cash-coin"></i>
                            </div>
                            <div class="ms-3 flex-grow-1 text-end">
                                <p class="card-text text-muted mb-0">Total Fees Collected</p>
                                <h4 class="card-title mb-0" id="total-collected">PKR 0</h4>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col">
                    <div class="card summary-card shadow-sm border-0 h-100">
                        <div class="card-body d-flex align-items-center">
                            <div class="card-icon bg-warning-subtle text-warning">
                                <i class="bi bi-person-check-fill"></i>
                            </div>
                            <div class="ms-3 flex-grow-1 text-end">
                                <p class="card-text text-muted mb-0">Fully Paid Students</p>
                                <h4 class="card-title mb-0" id="total-paid-students">0</h4>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col">
                    <div class="card summary-card shadow-sm border-0 h-100">
                        <div class="card-body d-flex align-items-center">
                            <div class="card-icon bg-secondary-subtle text-secondary">
                                <i class="bi bi-people-fill"></i>
                            </div>
                            <div class="ms-3 flex-grow-1 text-end">
                                <p class="card-text text-muted mb-0">Total Submissions</p>
                                <h4 class="card-title mb-0" id="total-submissions">0</h4>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm border-0">
                <div class="card-header bg-white border-0 py-3">
                    <h4 class="mb-0">Student Admission List</h4>
                </div>
                
                <div class="card-body border-bottom">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="input-group">
                                <span class="input-group-text bg-light border-0"><i class="bi bi-search"></i></span>
                                <input type="text" class="form-control border-0" id="search-bar" placeholder="Search by Name, ID, or Father's Name...">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="btn-group w-100" id="filter-btn-group">
                                <button class="btn btn-outline-secondary active" data-filter="all">All</button>
                                <button class="btn btn-outline-secondary" data-filter="unpaid">Unpaid</button>
                                <button class="btn btn-outline-secondary" data-filter="paid">Paid</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead>
                            <tr>
                                <th>Submission Date</th>
                                <th>Student Name</th>
                                <th>Admission ID</th>
                                <th>Class Sought</th>
                                <th>Fee Status</th>
                                <th class="text-end">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="student-list-body">
                            <tr>
                                <td colspan="6" class="text-center p-4">Loading student data...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>
    
    <div class="modal fade" id="studentModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="studentModalTitle">Loading Student...</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="studentModalBody">
                    <p>Loading details...</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-danger" id="delete-student-btn">Delete Student</button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Sidebar Toggle Script
        document.addEventListener('DOMContentLoaded', () => {
            const sidebar = document.getElementById('sidebar');
            const toggleBtn = document.getElementById('sidebar-toggle');
            const overlay = document.getElementById('sidebar-overlay');
            const toggleSidebar = () => {
                sidebar.classList.toggle('active');
                overlay.classList.toggle('active');
                document.body.classList.toggle('sidebar-active');
            };
            toggleBtn.addEventListener('click', toggleSidebar);
            overlay.addEventListener('click', toggleSidebar);
        });
    </script>
    
    <script type="module">
        // Import all functions we need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import {
            getFirestore, collection, getDocs, doc, getDoc,
            query, setDoc, updateDoc, deleteDoc
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- Your Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyDIVlksOyjV4e6TyiJysL7ovITrQ60v7Q4",
            authDomain: "feesystem-fe78e.firebaseapp.com",
            projectId: "feesystem-fe78e",
            storageBucket: "feesystem-fe78e.firebasestorage.app",
            messagingSenderId: "772128934957",
            appId: "1:772128934957:web:0eeeebed3be0343cf77ca4",
            measurementId: "G-XQ0HWT03HK"
        };
        // -----------------------------------------

        // --- Initialize Firebase ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- Get UI Elements ---
        const studentModal = new bootstrap.Modal(document.getElementById('studentModal'));
        const studentModalTitle = document.getElementById('studentModalTitle');
        const studentModalBody = document.getElementById('studentModalBody');
        const tableBody = document.getElementById('student-list-body');
        const deleteStudentBtn = document.getElementById('delete-student-btn');
        
        const totalCollectedEl = document.getElementById('total-collected');
        const totalPaidStudentsEl = document.getElementById('total-paid-students');
        const totalSubmissionsEl = document.getElementById('total-submissions');
        
        const searchBar = document.getElementById('search-bar');
        const filterButtonGroup = document.getElementById('filter-btn-group');

        // --- Global variables ---
        let currentStudentData = null;
        let currentStudentId = null;
        let allStudents = [];
        let currentFilter = 'all';
        let currentSearchTerm = '';

        // --- Default Fee Structure (fallback) ---
        const DEFAULT_FEES = {
            admissionFee: { status: "unpaid", amount: 5000 },
            securityFee: { status: "unpaid", amount: 3000 },
            tuitionFee: { status: "unpaid", amount: 2500 }
        };

        // --- 1. Fetch all students ONCE and store them ---
        async function fetchAllStudents() {
            tableBody.innerHTML = `<tr><td colspan="6" class="text-center p-4">Loading student data...</td></tr>`;
            allStudents = []; 
            try {
                const admissionsRef = collection(db, "admissions");
                const querySnapshot = await getDocs(admissionsRef);
                
                querySnapshot.forEach((doc) => {
                    allStudents.push({ id: doc.id, data: doc.data() });
                });

                allStudents.sort((a, b) => {
                    const classA = a.data.studentClass || '';
                    const classB = b.data.studentClass || '';
                    return classA.localeCompare(classB, undefined, { numeric: true });
                });
                
                renderTable();
            } catch (error) {
                console.error("Error fetching documents: ", error);
                tableBody.innerHTML = `<tr><td colspan="6" class="text-center text-danger p-4">Error loading data.</td></tr>`;
            }
        }

        // --- 2. Render the table based on filters ---
        function renderTable() {
            tableBody.innerHTML = '';
            
            let totalCollected = 0;
            let totalPaidStudents = 0;
            let totalSubmissions = allStudents.length;
            let rowsAdded = 0;
            let currentClass = "";
            
            const searchTerm = currentSearchTerm.toLowerCase();

            allStudents.forEach((studentDoc) => {
                const student = studentDoc.data;
                const docId = studentDoc.id; 

                // Use the updated getOverallFeeStatus
                const { statusBadge, isFullyPaid, studentTotalPaid, status } = getOverallFeeStatus(student.feeStatus, student);
                
                if (currentFilter !== 'all' && status !== currentFilter) {
                    return; 
                }

                if (searchTerm &&
                    !student.studentName.toLowerCase().includes(searchTerm) &&
                    !(student.admissionId || '').toLowerCase().includes(searchTerm) &&
                    !student.fatherName.toLowerCase().includes(searchTerm)
                ) {
                    return;
                }

                rowsAdded++;
                totalCollected += studentTotalPaid;
                if (isFullyPaid) {
                    totalPaidStudents++;
                }

                if (student.studentClass !== currentClass) {
                    currentClass = student.studentClass;
                    // --- NEW: Using the new CSS class for styling ---
                    const headingRow = `
                        <tr class="class-heading">
                            <td colspan="6">${currentClass || 'Unclassified'}</td>
                        </tr>
                    `;
                    tableBody.innerHTML += headingRow;
                }

                const submissionDate = student.submissionTimestamp 
                    ? student.submissionTimestamp.toDate().toLocaleDateString() 
                    : 'N/A';
                    
                const row = `
                    <tr>
                        <td>${submissionDate}</td>
                        <td>${student.studentName}</td>
                        <td>${student.admissionId || '...'}</td>
                        <td>${student.studentClass}</td>
                        <td>${statusBadge}</td>
                        <td class="text-end text-nowrap">
                            <button class="btn btn-primary btn-sm" data-doc-id="${docId}">
                                Manage
                            </button>
                            <button class="btn btn-info btn-sm print-btn" data-doc-id="${docId}">
                                Print
                            </button>
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
            
            if (rowsAdded === 0) {
                const message = totalSubmissions > 0 ? "No students match your filter/search." : "No submissions found.";
                tableBody.innerHTML = `<tr><td colspan="6" class="text-center p-4">${message}</td></tr>`;
            }
            
            totalCollectedEl.textContent = `PKR ${totalCollected.toLocaleString()}`;
            totalPaidStudentsEl.textContent = totalPaidStudents;
            totalSubmissionsEl.textContent = totalSubmissions;
        }

        // --- 3. Function to open the "Manage" modal ---
        async function openModal(studentId) {
            currentStudentId = studentId;
            studentModalTitle.textContent = 'Loading Student...';
            studentModalBody.innerHTML = '<p class="text-center p-4">Loading details...</p>';
            studentModal.show();
            try {
                const docRef = doc(db, "admissions", studentId);
                const docSnap = await getDoc(docRef);
                if (!docSnap.exists()) {
                    studentModalTitle.textContent = 'Error';
                    studentModalBody.innerHTML = '<p class="text-danger p-4">Could not find student data.</p>';
                    return;
                }
                let student = docSnap.data();
                
                // Use manual fees from form as the amounts if feeStatus doesn't exist
                if (!student.feeStatus) {
                    const manualFees = {
                        admissionFee: { status: "unpaid", amount: Number(student.admissionFee) || 0 },
                        securityFee: { status: "unpaid", amount: Number(student.securityFee) || 0 },
                        tuitionFee: { status: "unpaid", amount: Number(student.tuitionFee) || DEFAULT_FEES.tuitionFee.amount }
                    };
                    student.feeStatus = manualFees;
                    await setDoc(docRef, { feeStatus: manualFees }, { merge: true });
                }
                
                currentStudentData = student;
                studentModalTitle.textContent = `Manage: ${student.studentName}`;
                buildModalBody(student);
            } catch (error) {
                console.error("Error getting document:", error);
                studentModalBody.innerHTML = '<p class="text-danger p-4">Error loading document.</p>';
            }
        }

        // --- 4. Function to build the modal's HTML ---
        function buildModalBody(student) {
             const fs = student.feeStatus;
             const getBadge = (feeName, status) => { return status === 'paid' ? `<span class="badge bg-success" data-fee-name="${feeName}">Paid</span>` : `<span class="badge bg-danger" data-fee-name="${feeName}">Unpaid</span>`; };
             const getButton = (feeName, feeData) => { const name = feeName.charAt(0).toUpperCase() + feeName.slice(1).replace('Fee', ''); return feeData.status === 'paid' ? `<button class="btn btn-secondary" type="button" disabled>Payment Logged</button>` : `<button class="btn btn-success log-payment-btn" type="button" data-fee-name="${feeName}">Log ${name} Fee Payment</button>`; };
             studentModalBody.innerHTML = `
                <h5>Student Details</h5>
                <div class="row bg-light p-3 rounded-3 mb-3">
                    <div class="col-md-6"><p class="mb-1 text-muted small">Admission ID</p><p class="fw-bold">${student.admissionId || 'N/A'}</p></div>
                    <div class="col-md-6"><p class="mb-1 text-muted small">Father's Name</p><p class="fw-bold">${student.fatherName || 'N/A'}</p></div>
                    <div class="col-md-6"><p class="mb-1 text-muted small">Class</p><p class="fw-bold">${student.studentClass || 'N/A'}</p></div>
                    <div class="col-md-6"><p class="mb-1 text-muted small">Contact</p><p class="fw-bold">${student.contactDetails || 'N/A'}</p></div>
                    <div class="col-md-6"><p class="mb-1 text-muted small">Date of Birth</p><p class="fw-bold">${student.studentDOB || 'N/A'}</p></div>
                </div>
                <hr class="my-4">
                <h3 class="h4">Fee Management</h3>
                <div class="row">
                    <div class="col-md-6">
                        <h5>Fee Status</h5>
                        <ul class="list-group" id="fee-status-list">
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    Admission Fee
                                    <span class="text-muted d-block small">PKR ${fs.admissionFee.amount.toLocaleString()}</span>
                                </div>
                                ${getBadge('admissionFee', fs.admissionFee.status)}
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    Security Fee
                                    <span class="text-muted d-block small">PKR ${fs.securityFee.amount.toLocaleString()}</span>
                                </div>
                                ${getBadge('securityFee', fs.securityFee.status)}
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    Tuition Fee
                                    <span class="text-muted d-block small">PKR ${fs.tuitionFee.amount.toLocaleString()}</span>
                                </div>
                                ${getBadge('tuitionFee', fs.tuitionFee.status)}
                            </li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h5>Actions</h5>
                        <div class="d-grid gap-2">
                            ${getButton('admissionFee', fs.admissionFee)}
                            ${getButton('securityFee', fs.securityFee)}
                            ${getButton('tuitionFee', fs.tuitionFee)}
                            <hr>
                            <button class="btn btn-warning" type="button" id="generate-challan-btn">
                                <i class="bi bi-receipt-cutoff me-2"></i>Generate New Challan
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // --- 5. Helper function to get dashboard badge (UPDATED) ---
        function getOverallFeeStatus(feeStatus, student) {
            let isFullyPaid = false;
            let studentTotalPaid = 0;
            
            const fs = feeStatus || {
                admissionFee: { status: "unpaid", amount: Number(student.admissionFee) || 0 },
                securityFee: { status: "unpaid", amount: Number(student.securityFee) || 0 },
                tuitionFee: { status: "unpaid", amount: Number(student.tuitionFee) || 0 }
            };

            let allPaid = true;
            for (const feeName in fs) {
                if (fs[feeName].status === 'paid') {
                    studentTotalPaid += fs[feeName].amount;
                } else if (fs[feeName].amount > 0) { // Only count as unpaid if fee is > 0
                    allPaid = false;
                }
            }
            
            if (allPaid) {
                isFullyPaid = true;
                return { statusBadge: `<span class="badge bg-success">Paid</span>`, isFullyPaid, studentTotalPaid, status: 'paid' };
            }
            
            return { statusBadge: `<span class="badge bg-danger">Unpaid</span>`, isFullyPaid, studentTotalPaid, status: 'unpaid' };
        }

        // --- 6. Main event listeners ---
        
        searchBar.addEventListener('input', (e) => {
            currentSearchTerm = e.target.value;
            renderTable(); 
        });
        
        filterButtonGroup.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                filterButtonGroup.querySelector('.active').classList.remove('active');
                e.target.classList.add('active');
                currentFilter = e.target.dataset.filter;
                renderTable();
            }
        });

        tableBody.addEventListener('click', async (event) => {
            if (event.target.classList.contains('btn-primary')) {
                const studentId = event.target.getAttribute('data-doc-id');
                openModal(studentId);
            }
            else if (event.target.classList.contains('print-btn')) {
                const studentId = event.target.getAttribute('data-doc-id');
                if (!studentId) return;
                try {
                    const docRef = doc(db, "admissions", studentId);
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        localStorage.setItem('lastSubmissionData', JSON.stringify(docSnap.data()));
                        window.open('print.html', '_blank');
                    } else {
                        alert('Error: Could not find student data.');
                    }
                } catch (e) {
                    console.error("Error fetching doc for printing: ", e);
                    alert('An error occurred.');
                }
            }
        });

        // Listen for clicks *inside* the modal
        studentModalBody.addEventListener('click', async (event) => {

            // A) Challan Button Logic
            if (event.target.id === 'generate-challan-btn') {
                if (!currentStudentData) return;

                // --- THIS IS THE FIX ---
                // We now read the dates from the student data first,
                // and only create new ones if the fields are empty.
                const challanData = {
                    student: currentStudentData,
                    fees: {
                        admission: currentStudentData.feeStatus.admissionFee.status === 'unpaid' ? currentStudentData.feeStatus.admissionFee.amount : 0,
                        security: currentStudentData.feeStatus.securityFee.status === 'unpaid' ? currentStudentData.feeStatus.securityFee.amount : 0,
                        tuition: currentStudentData.feeStatus.tuitionFee.status === 'unpaid' ? currentStudentData.feeStatus.tuitionFee.amount : 0
                    },
                    // Use saved date, or create a new one as a fallback
                    issueDate: currentStudentData.chalanIssued || new Date().toLocaleDateString(),
                    dueDate: currentStudentData.dueDate || new Date(new Date().setDate(new Date().getDate() + 10)).toLocaleDateString()
                };
                // --- END OF FIX ---

                localStorage.setItem('challanData', JSON.stringify(challanData));
                window.open('challan.html', '_blank');
            }

            // B) Log Payment Button Logic
            if (event.target.classList.contains('log-payment-btn')) {
                // ... (your existing payment logic is correct) ...
                const feeName = event.target.getAttribute('data-fee-name');
                if (!feeName || !currentStudentId) return;

                event.target.disabled = true;
                event.target.textContent = 'Saving...';
                try {
                    const updatePath = `feeStatus.${feeName}.status`;
                    const docRef = doc(db, "admissions", currentStudentId);
                    await updateDoc(docRef, { [updatePath]: "paid" });

                    const updatedStudent = allStudents.find(s => s.id === currentStudentId);
                    if(updatedStudent) {
                        updatedStudent.data.feeStatus[feeName].status = 'paid';
                    }
                    currentStudentData.feeStatus[feeName].status = 'paid'; 

                    buildModalBody(currentStudentData);
                    renderTable();
                } catch (e) {
                    console.error("Error updating document: ", e);
                    alert('Error saving payment.');
                    event.target.disabled = false;
                    event.target.textContent = 'Log Payment';
                }
            }
        });

        deleteStudentBtn.addEventListener('click', async () => {
            if (!currentStudentId) return;
            if (confirm(`Are you sure you want to delete ${currentStudentData.studentName}? This cannot be undone.`)) {
                try {
                    await deleteDoc(doc(db, "admissions", currentStudentId));
                    studentModal.hide();
                    allStudents = allStudents.filter(s => s.id !== currentStudentId);
                    renderTable();
                } catch (e) {
                    console.error("Error deleting document: ", e);
                    alert('Error deleting student.');
                }
            }
        });

        // --- 7. Start the app ---
        fetchAllStudents(); // Load the cache
    </script>
</body>
</html>